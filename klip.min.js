if(typeof klip=="undefined")var klip={};if(typeof Object.assign!="function"){(function(){Object.assign=function(target){"use strict";if(target===undefined||target===null){throw new TypeError("Cannot convert undefined or null to object")}var output=Object(target);for(var index=1;index<arguments.length;index++){var source=arguments[index];if(source!==undefined&&source!==null){for(var nextKey in source){if(source.hasOwnProperty(nextKey)){output[nextKey]=source[nextKey]}}}}return output}})()}(function(){var settings={flexHeight:true};var stage={img:{size:{x:0,y:0},ratio:0},size:{x:0,y:0},zoom:1,offset:{x:0,y:0}};var canvas={size:{x:0,y:0},ratio:0,offset:{x:0,y:0},dnd:{stage:0,fposx:0,fposy:0,fobj:null}};var objects=[];var __klip={};this.create=function(conID,bgIMGurl,objs){__klip.container=document.getElementById(conID);__klip.container.innerHTML="";var cnvElm=document.createElement("CANVAS");cnvElm.id="klipElm";document.getElementById(conID).appendChild(cnvElm);__klip.c=document.getElementById(cnvElm.id);__klip.ct=__klip.c.getContext("2d");objects=objs;__klip.constants={animations:{fadein:"fadein",flyin:"flyin",fadeout:"fadeout"},events:{show:"show",hide:"hide"}};__klip.eventAnimRel={};__klip.eventAnimRel[__klip.constants.events.show]=[__klip.constants.animations.fadein,__klip.constants.animations.flyin];__klip.eventAnimRel[__klip.constants.events.hide]=[__klip.constants.animations.fadeout];__klip.background_img=new Image;__klip.background_img_url=bgIMGurl;__klip.background_img.src=__klip.background_img_url;__klip.background_img.onload=function(e){stage.size.x=__klip.background_img.width;stage.size.y=__klip.background_img.height;stage.img.size.x=__klip.background_img.width;stage.img.size.y=__klip.background_img.height;initObjects()};createClick();window.addEventListener("resize",respondCanvas)};function getOffset(el){var rect=el.getBoundingClientRect();return{top:rect.top+document.body.scrollTop,left:rect.left+document.body.scrollLeft}}function respondCanvas(){canvas.offset.x=getOffset(__klip.c).left;canvas.offset.y=getOffset(__klip.c).top;canvas.size.x=__klip.container.offsetWidth;__klip.c.setAttribute("width",__klip.container.offsetWidth);if(settings.flexHeight){var nheight=stage.img.size.y/stage.img.size.x*__klip.container.offsetWidth;__klip.c.setAttribute("height",nheight);canvas.size.y=nheight}else{__klip.c.setAttribute("height",__klip.container.offsetHeight);canvas.size.y=__klip.container.offsetHeight}stage.img.ratio=stage.img.size.y/stage.img.size.x;canvas.ratio=canvas.size.y/canvas.size.x;stage.size.y=0;stage.size.x=0;if(canvas.ratio>stage.img.ratio){stage.size.y=canvas.size.y;stage.size.x=canvas.size.y/stage.img.ratio}else{stage.size.x=canvas.size.x;stage.size.y=canvas.size.x*stage.img.ratio}stage.zoom=100/stage.img.size.x*stage.size.x/100;stage.offset.y=getCenteroffsety();stage.offset.x=getCenteroffsetx();updateCanvas()}function getCenteroffsety(){var zmoffset=Math.max(canvas.size.y-stage.size.y,0);var offsety=-1*((stage.size.y-canvas.size.y)/2)-zmoffset/2;return offsety}function getCenteroffsetx(){var zmoffset=canvas.size.x-stage.size.x;return zmoffset/2}function initObjects(){goThroughelm(objects,null);function goThroughelm(obj,parent){for(var i=0;i<obj.length;i++){var el=obj[i];if(parent){el.__prnt=parent}if(el.hasOwnProperty("child")){goThroughelm(el.child,el)}}}respondCanvas()}function updateCanvas(){__klip.ct.drawImage(__klip.background_img,stage.offset.x,stage.offset.y,stage.size.x,stage.size.y);renderObjects(objects);requestAnimationFrame(updateCanvas)}function renderObjects(ary){for(var i=0;i<ary.length;i++){var el=ary[i];drawObject(el);if(el.hasOwnProperty("child")&&el.child.length>0&&el.visible&&el.visible==true){renderObjects(el.child)}}}function getRelPoint(x,y){return{x:stage.offset.x+x*stage.zoom,y:stage.offset.y+y*stage.zoom}}function resRelPoint(x,y){return{x:(x-stage.offset.x)/stage.zoom,y:y/stage.zoom-stage.offset.y}}function getRelPos(el){return{x:stage.offset.x+el.pos.x*stage.zoom,y:stage.offset.y+el.pos.y*stage.zoom,w:el.size.x*stage.zoom,h:el.size.y*stage.zoom}}function getObjPos(el){if(el.__prnt){return getRelPos({pos:{x:el.__prnt.pos.x+el.pos.x,y:el.__prnt.pos.y+el.pos.y},size:{x:el.size.x,y:el.size.y}})}else{return getRelPos(el)}}function drawObject(el){var props=Object.assign({},el);if(el.__anim&&el.__anim.active.length>0){drawAnimation(el);props=Object.assign(props,el.__anim.props)}if(el.hasOwnProperty("visible"))if(el.visible==false)return;switch(el.type){case"rect":var elmp=getObjPos(el);if(props.color){__klip.ct.fillStyle=getColorRGBA(props.color)}__klip.ct.fillRect(elmp.x,elmp.y,elmp.w,elmp.h);break;case"imgrect":var elmp=getObjPos(el);if(!el.img){el.img=new Image;el.img.src=el.img_url;el.img.onload=function(){drawObject(el)}}else{if(props.alpha){__klip.ct.globalAlpha=props.alpha}__klip.ct.drawImage(el.img,elmp.x,elmp.y,elmp.w,elmp.h);if(props.alpha){__klip.ct.globalAlpha=1}}break;case"connector":var points=[],obj1=getObjfromID(el.from),obj2=getObjfromID(el.to);var pos1={x:obj1.pos.x+obj1.size.x/2,y:obj1.pos.y+obj1.size.y/2},pos2={x:obj2.pos.x+obj2.size.x/2,y:obj2.pos.y+obj2.size.y/2};var pos1rel=getRelPoint(pos1.x,pos1.y),pos2rel=getRelPoint(pos2.x,pos2.y);points.push([pos1rel.x,pos1rel.y]);points.push([pos2rel.x,pos2rel.y]);var angle=getAngleBetweenPoints(points[0][0],points[0][1],points[1][0],points[1][1]);__klip.ct.beginPath();__klip.ct.moveTo(points[0][0],points[0][1]);var angleR=angle;var distance=getDistance(points[0][0],points[0][1],points[1][0],points[1][1]);var point2x=points[0][0]+distance/2*Math.cos(angleR);var point2y=points[0][1]+distance/2*Math.sin(angleR);var point2x2=point2x+distance/3*Math.cos(angleR+toRan(Math.sign(points[0][0]-points[1][0])*90));var point2y2=point2y+distance/3*Math.sin(angleR+toRan(Math.sign(points[0][0]-points[1][0])*90));__klip.ct.lineTo(point2x2,point2y2);__klip.ct.lineTo(points[1][0],points[1][1]);__klip.ct.lineWidth=3;__klip.ct.strokeStyle="#FFFFFF";__klip.ct.stroke();break;case"textbox":var elmp=getObjPos(el);var fillStyle="#000000";if(props.color){fillStyle=getColorRGBA(props.color)}create_text_wrap(__klip.ct,elmp.x,elmp.y,elmp.w,elmp.h,el.text,20*stage.zoom,2*stage.zoom,fillStyle);break;default:}}function getAngleBetweenPoints(x1,y1,x2,y2){var deltaY=y2-y1;var deltaX=x2-x1;return angle_trunc(Math.atan2(deltaY,deltaX));function angle_trunc(a){while(a<0){a+=Math.PI*2}return a}}function roundToNearestNum(num,k,step){var stepsInK=k/step;return Math.round(stepsInK/k*num)*step}function getDistance(x1,y1,x2,y2){return Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))}function toRan(deg){return deg*Math.PI/180}function getObjfromID(id,obj){if(!obj){obj=objects}if(!obj)return{};var foundObj={};runOnArray(obj,function(e){if(e.id==id){foundObj=e}},[]);return foundObj}function drawAnimation(el){for(var i=0;i<el.__anim.active.length;i++){var animation=el.animation.filter(function(e){return e.type==el.__anim.active[i].type})[0];switch(animation.type){case __klip.constants.animations.fadein:el.visible=true;var process=(Date.now()-el.__anim.active[i].time)/animation.time;if(el.type=="imgrect"){el.__anim.props.alpha=process/1;if(process>=1){el.__anim.props.alpha=1;el.__anim.active=el.__anim.active.filter(function(e){return e.type!=animation.type});el.visible=true;return}return}el.__anim.props.color=[];var color=el.__anim.props.color;color=Object.assign(color,el.color);if(process>=1){color[3]=el.color[3];el.__anim.active=el.__anim.active.filter(function(e){return e.type!=animation.type});return}color[3]=process/1*el.color[3];break;case __klip.constants.animations.fadeout:var process=(Date.now()-el.__anim.active[i].time)/animation.time;if(el.type=="imgrect"){el.__anim.props.alpha=1-process/1;if(process>=1){el.__anim.props.alpha=0;el.__anim.active=el.__anim.active.filter(function(e){return e.type!=animation.type});el.visible=false;return}return}if(!el.color)return;el.__anim.props.color=[];var color=el.__anim.props.color;color=Object.assign(color,el.color);if(process>=1){color[3]=0;el.__anim.active=el.__anim.active.filter(function(e){return e.type!=animation.type});el.visible=false;return}color[3]=el.color[3]-process/1*el.color[3];break;default:}}}function createAnimation(el,event){if(el.animation){if(!el.__anim){el.__anim={active:[],props:{}}}}else{return}var anims=el.animation.filter(function(e){return e.on==event});for(var i=0;i<anims.length;i++){var animation=anims[i];switch(animation.type){case __klip.constants.animations.fadein:addToActiveAnimation(el,{type:animation.type,time:Date.now()});break;case __klip.constants.animations.fadeout:addToActiveAnimation(el,{type:animation.type,time:Date.now()});break;default:}}}function runOnArray(obj,fnct,params){for(var i=0;i<obj.length;i++){var el=obj[i];var nparams=params.slice(0);nparams.unshift(el);fnct.apply(this,nparams);if(el.hasOwnProperty("child")){runOnArray(el.child,fnct,params)}}}function addToActiveAnimation(el,obj){el.__anim.active.push(obj)}function getClickedObj(event){var clickedObjects=[];function checkObjs(obj){for(var i=0;i<obj.length;i++){var el=obj[i];if(el.hasOwnProperty("visible"))if(el.visible==false)continue;var hit=checkClick(el,event.pageX-canvas.offset.x,event.pageY-canvas.offset.y);if(hit&&(!el.hasOwnProperty("clickable")||el.hasOwnProperty("clickable")&&el.clickable)&&(!el.hasOwnProperty("__anim")||el.hasOwnProperty("__anim")&&el.__anim.active.length==0)){clickedObjects.push(el);if(el.hasOwnProperty("child")){checkObjs(el.child)}}}}checkObjs(objects);return clickedObjects}function checkClick(obj,x,y){if(!obj.pos){return}var elmp=getObjPos(obj);if(y>elmp.y&&y<elmp.y+elmp.h&&x>elmp.x&&x<elmp.x+elmp.w){return true}else{return false}}function clickAction(obj){if(!obj.onClick)return;for(var i=0;obj.onClick.length>0;i++){if(!obj.onClick[i])return;var el=obj.onClick[i];execOnClick(el)}}function isFunction(functionToCheck){var getType={};return functionToCheck&&getType.toString.call(functionToCheck)==="[object Function]"}function execOnClick(obj){var type=obj.type;if(isFunction(obj.type)){type=obj.type(getObjfromID)}switch(type){case"show":var shObj=objects.filter(function(e){return e.id==obj.id});if(shObj.length>0&&!shObj[0].visible){if(shObj[0].hasOwnProperty("child")){createAnimation(shObj[0],type);runOnArray(shObj[0].child,createAnimation,[type])}createAnimation(shObj[0],type)}break;case"hide":var shObj=objects.filter(function(e){return e.id==obj.id});if(shObj.length>0&&shObj[0].visible){if(shObj[0].hasOwnProperty("child")){createAnimation(shObj[0],type);runOnArray(shObj[0].child,createAnimation,[type])}createAnimation(shObj[0],type)}break;default:}}function getColorRGBA(el_color,opacity){return"rgba("+el_color[0]+","+el_color[1]+","+el_color[2]+","+(opacity||el_color[3])+")"}function addEvent(element,evnt,funct){if(element.attachEvent)return element.attachEvent("on"+evnt,funct);else return element.addEventListener(evnt,funct,false)}function createClick(){addEvent(__klip.c,"click",function(event){var clickedObjects=getClickedObj(event);if(clickedObjects.length>0){clickAction(clickedObjects[clickedObjects.length-1],true)}});addEvent(__klip.c,"mousedown",function(event){var clickedObjects=getClickedObj(event);if(clickedObjects.length>0){var obj=clickedObjects[clickedObjects.length-1];if(obj.draggable){canvas.dnd.stage=1}else{return}}else{return}if(obj.hasOwnProperty("dragID")){obj=getObjfromID(obj.dragID)}var relPos=getRelPos(obj);canvas.dnd.fposx=event.pageX-canvas.offset.x-relPos.x;canvas.dnd.fposy=event.pageY-canvas.offset.y-relPos.y;canvas.dnd.fobj=obj});addEvent(__klip.c,"mousemove",function(event){if(canvas.dnd.stage==1){canvas.dnd.stage=2}if(canvas.dnd.stage==2){var npos=resRelPoint(event.pageX-canvas.offset.x-canvas.dnd.fposx,event.pageY-canvas.offset.y-canvas.dnd.fposy);canvas.dnd.fobj.pos.x=npos.x;canvas.dnd.fobj.pos.y=npos.y}});addEvent(__klip.c,"mouseup",function(event){canvas.dnd.stage=0})}function create_text_wrap(ctx,x,y,w,h,text,fh,spl,fillStyle){var Paint={VALUE_FONT:fh+"px Arial"};var split_lines=function(mw,font,text){mw=mw;ctx.font=font;ctx.fillStyle=fillStyle;var words=text.split(" ");var new_line=words[0];var lines=[];for(var i=1;i<words.length;++i){if(ctx.measureText(new_line+" "+words[i]).width<mw){new_line+=" "+words[i]}else{lines.push(new_line);new_line=words[i]}}lines.push(new_line);return lines};if(ctx){var lines=split_lines(w,Paint.VALUE_FONT,text);var both=lines.length*(fh+spl);if(both>=h&&false){console.log("kaputt")}else{var ly=(h-both)/2+y+spl*lines.length;var lx=0;for(var j=0,ly;j<lines.length;++j,ly+=fh+spl){if(false){lx=x+w/2-ctx.measureText(lines[j]).width/2}else{lx=x}ctx.fillText(lines[j],lx,ly)}}}else{}}}).call(klip);